<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Grenden Garage</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  <script src="/static/js/mqtt.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      text-align: center;
    }
    #chartContainer {
      width: 800px;
      height: 450px;
      margin: 0 auto;
    }
    img.logo {
      float: left;
      height: 60px;
    }
    #garageTitle {
      margin-left: 50px; /* move left/right as needed */
      font-weight: bold;
      margin-bottom: 30px;
    }
    .clearfix::after {
      content: "";
      clear: both;
      display: table;
    }
  </style>
</head>
<body>
  <div class="clearfix">
    <img src="/static/image/axis_logo.png" alt="Axis Logo" class="logo" />
    <h1 id="garageTitle">Grenden Garage</h1>
  </div>

  <div id="chartContainer"></div>

  <script>
    const host = "populus-mqtt-dev2.safecity.axis.com";

    const topic = [
      "garage-1/p-free",
      "garage-1/e-free",
      "garage-2/p-free",
      "garage-2/e-free",
    ];

    const labels = {
      "garage-1/p-free": "Floor -1 - P",
      "garage-1/e-free": "Floor -1 - EL",
      "garage-2/p-free": "Floor -2 - P",
      "garage-2/e-free": "Floor -2 - EL",
    };

    const jGarage = {
      "garage-1": {
        "p": { total: 25 },
        "e": { total: 5 }
      },
      "garage-2": {
        "p": { total: 37 },
        "e": { total: 6 }
      }
    };

    const parkingData = {
      "garage-1/p-free": { free: 0, occupied: 0 },
      "garage-1/e-free": { free: 0, occupied: 0 },
      "garage-2/p-free": { free: 0, occupied: 0 },
      "garage-2/e-free": { free: 0, occupied: 0 },
    };

    const chart = echarts.init(document.getElementById('chartContainer'));

    const option = {
      title: {
        text: 'Parking Availability by Floor',
        left: 'center',
        top: 20,
        textStyle: {
          fontWeight: 'bold',
          fontSize: 22
        }
      },
      tooltip: {
        trigger: 'axis',
        axisPointer: { type: 'shadow' },
        formatter: params => {
          let result = params[0].axisValue + '<br/>';
          params.forEach(item => {
            result += `<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${item.color};"></span>`;
            result += `${item.seriesName}: ${item.data}<br/>`;
          });
          return result;
        }
      },
      legend: {
        data: ['Free', 'Occupied'],
        bottom: 10,
        textStyle: { fontSize: 16 }
      },
      grid: {
        left: 70,
        right: 40,
        bottom: 70,
        top: 80,
        containLabel: true
      },
      xAxis: {
        type: 'category',
        data: Object.values(labels),
        axisLabel: { fontSize: 14 }
      },
      yAxis: {
        type: 'value',
        name: 'Spaces',
        min: 0,
        axisLabel: { fontSize: 14 },
        nameTextStyle: { fontWeight: 'bold' }
      },
      series: [
        {
          name: 'Free',
          type: 'bar',
          stack: 'total',
          itemStyle: { color: '#4CAF50' },
          label: {
            show: true,
            position: 'inside',
            formatter: params => params.value === 0 ? '' : params.value,
            fontWeight: 'bold',
            color: '#fff'
          },
          data: []
        },
        {
          name: 'Occupied',
          type: 'bar',
          stack: 'total',
          itemStyle: { color: '#F44336' },
          label: {
            show: true,
            position: 'inside',
            formatter: params => params.value === 0 ? '' : params.value,
            fontWeight: 'bold',
            color: '#fff'
          },
          data: []
        }
      ]
    };

    chart.setOption(option);

    function getTotalFromTopic(tpc) {
      const parts = tpc.split('/');
      if (parts.length < 2) return 0;
      const garage = parts[0];
      const type = parts[1].split('-')[0];
      return (jGarage[garage] && jGarage[garage][type]) ? jGarage[garage][type].total : 0;
    }

    function updateChart() {
      const freeData = [];
      const occupiedData = [];
      topic.forEach(tpc => {
        const free = parkingData[tpc].free || 0;
        const total = getTotalFromTopic(tpc);
        const occupied = total - free;
        freeData.push(free);
        occupiedData.push(occupied);
      });

      chart.setOption({
        series: [
          { data: freeData },
          { data: occupiedData }
        ]
      });
    }

    function notifyMQTTConnected(mqtt) {
      console.log('MQTT connected');
      topic.forEach(tpc => mqtt.subscribe(tpc));
    }

    function notifyMQTTMsgReceived(msg) {
      const tpc = msg.destinationName;
      const payload = msg.payloadString;

      if (!topic.includes(tpc)) return;

      const total = getTotalFromTopic(tpc);
      let freeCount = Number(payload);
      if (isNaN(freeCount) || freeCount > total || freeCount < 0) {
        console.warn(`Invalid free count for ${tpc}: ${payload}`);
        return;
      }

      parkingData[tpc] = {
        free: freeCount,
        occupied: total - freeCount
      };

      updateChart();
    }

    MQTTconnect();
  </script>
</body>
</html>
